<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Little Biochemist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #fff7ed;
            overflow: hidden;
            touch-action: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Standard Scrollbar for Inventory */
        .inventory-scroll {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
        }

        .inventory-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .inventory-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }

        /* Game Elements */
        .molecule {
            transition: transform 0.1s;
            filter: drop-shadow(2px 2px 0px rgba(0, 0, 0, 0.1));
            touch-action: none;
            will-change: transform, left, top;
            /* Performance hint */
        }

        /* Dragging State */
        .molecule.dragging {
            position: fixed !important;
            z-index: 9999 !important;
            pointer-events: none;
            opacity: 0.9;
            /* transform handled by JS now */
            filter: drop-shadow(0px 15px 30px rgba(0, 0, 0, 0.3));
            transition: none !important;
        }

        .inventory-item {
            transition: all 0.2s;
        }

        .inventory-item:active {
            transform: scale(0.95);
            background-color: #ffedd5;
        }

        /* Enzyme/Pathway Box Styling */
        .enzyme-box {
            border: 3px dashed #78716c;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .enzyme-box.pathway {
            border-color: #be185d;
            background-color: rgba(255, 241, 242, 0.7);
        }

        .enzyme-box.active-reaction {
            border-color: #f59e0b;
            background-color: rgba(251, 191, 36, 0.2);
            animation: pulse-orange 1s infinite;
        }

        .enzyme-box.reject {
            animation: shake 0.4s ease-in-out;
            border-color: #ef4444;
        }

        /* Trash Bin Styling */
        .trash-bin {
            transition: all 0.2s;
            border: 2px dashed #fca5a5;
        }

        .trash-bin.hovered {
            transform: scale(1.1);
            background-color: #fee2e2;
            border-color: #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        @keyframes pulse-orange {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
            }

            50% {
                transform: scale(1.02);
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* Atom Styling */
        .atom {
            stroke: #1e293b;
            stroke-width: 2px;
        }

        .atom-c {
            fill: #3b82f6;
        }

        .atom-o {
            fill: #ef4444;
        }

        .atom-h {
            fill: #ffffff;
        }

        .bond {
            stroke: #1e293b;
            stroke-width: 3px;
            stroke-linecap: round;
        }

        .lipid-stroke {
            stroke: #854d0e;
            stroke-width: 4px;
            stroke-linecap: round;
        }

        /* Tabs */
        .tab-btn {
            padding: 8px 4px;
            font-size: 11px;
            font-weight: 700;
            color: #64748b;
            border-radius: 8px;
            transition: all 0.2s;
            flex: 1;
            text-align: center;
            background-color: transparent;
            cursor: pointer;
        }

        .tab-btn.active {
            color: #ea580c;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* --- RESPONSIVE CONTAINERS --- */
        .molecule-container {
            width: 5rem;
            /* w-20 = 5rem = 80px */
            height: 5rem;
        }

        .enzyme-container {
            width: 12rem;
            /* w-48 = 12rem = 192px */
            height: 10rem;
            /* h-40 = 10rem = 160px */
        }

        @media (max-width: 768px) {
            .molecule-container {
                width: 4rem;
                /* 48px - very compact */
                height: 4rem;
            }

            .enzyme-container {
                width: 8.5rem;
                /* Compact mobile enzyme */
                height: 7rem;
                border-width: 2px;
            }
        }
    </style>
</head>

<body class="h-screen w-screen flex flex-col overflow-hidden">

    <!-- Top Bar -->
    <header
        class="bg-white/90 backdrop-blur border-b border-orange-200 p-3 flex justify-between items-center z-30 shrink-0 shadow-sm h-14 md:h-16">
        <div class="flex items-center gap-2">
            <div
                class="w-8 h-8 rounded-lg bg-orange-500 flex items-center justify-center text-white font-bold shadow-sm">
                LB</div>
            <div class="flex flex-col leading-tight">
                <h1 class="text-sm md:text-lg font-bold text-slate-800 tracking-wide">LITTLE BIOCHEMIST</h1>
                <div class="flex gap-1">
                    <span id="mode-badge"
                        class="text-[10px] text-green-700 bg-green-100 border border-green-200 px-2 py-0.5 rounded-full font-bold tracking-wider w-fit cursor-pointer hover:bg-green-200 transition"
                        onclick="toggleGameMode()">LIPID SANDBOX</span>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="resetGame()"
                class="text-xs font-bold bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded-full transition shadow-sm border border-slate-200">
                ‚Ü∫ Reset
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 flex flex-col md:flex-row relative overflow-hidden">

        <!-- Workbench -->
        <main id="workbench"
            class="flex-1 relative bg-orange-50/50 bg-[radial-gradient(#fed7aa_1px,transparent_1px)] [background-size:20px_20px] order-1 md:order-2 overflow-hidden flex flex-col">
            <div
                class="absolute top-4 left-4 text-orange-300 font-bold text-lg opacity-50 pointer-events-none select-none hidden md:block">
                WORKBENCH
            </div>

            <!-- Campaign Objective Panel (Hidden in Sandbox) -->
            <div id="campaign-hud"
                class="hidden absolute top-4 left-0 right-0 z-20 pointer-events-none flex justify-center">
                <div
                    class="bg-white/90 backdrop-blur border-b-4 border-orange-400 shadow-sm px-6 py-2 rounded-xl flex flex-col items-center">
                    <div class="text-[10px] uppercase font-bold text-orange-400 tracking-widest mb-0.5"
                        id="topic-title">TOPIC 1</div>
                    <div class="text-sm font-bold text-slate-700" id="topic-objective">Break down the fat</div>
                </div>
            </div>

            <div id="tutorial-msg"
                class="absolute inset-0 flex items-center justify-center pointer-events-none p-6 z-0">
                <div
                    class="bg-white/80 backdrop-blur-sm px-6 py-6 rounded-2xl text-slate-600 text-center shadow-lg border-2 border-orange-100 max-w-sm">
                    <p class="font-bold text-lg mb-2 text-orange-800">Start Experimenting!</p>
                    <p class="text-sm leading-relaxed">Click items in the inventory to add them.</p>
                </div>
            </div>

            <!-- Trash Bin -->
            <div id="trash-bin"
                class="trash-bin absolute bottom-12 right-4 w-12 h-12 md:w-20 md:h-20 bg-white/80 backdrop-blur rounded-2xl flex items-center justify-center shadow-lg z-10 transition-colors">
                <div class="pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                        stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </div>
            </div>

            <!-- Topic Complete Modal -->
            <div id="topic-complete-modal"
                class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/20 backdrop-blur-[1px]">
                <div
                    class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center border-4 border-green-400 animate-[bounce_0.5s_ease-out]">
                    <div class="text-4xl mb-2">üéâ</div>
                    <h2 class="text-xl font-bold text-green-800 mb-1">Topic Completed!</h2>
                    <p class="text-slate-600 text-sm mb-4">Excellent work!</p>
                    <div class="flex justify-center gap-3">
                        <button onclick="GameManager.stayOnWorkbench()"
                            class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-xl transition text-sm">
                            Go back
                        </button>
                        <button onclick="GameManager.returnToMenu()"
                            class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-xl transition shadow-lg text-sm">
                            Menu
                        </button>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div
                class="mt-auto w-full text-center text-[10px] text-slate-400 p-2 pointer-events-none select-none bg-orange-50/30">
                ¬© 2026 Wong Gou Rean. All rights reserved.
            </div>
        </main>

        <!-- Inventory Sidebar -->
        <aside class="
            order-2 md:order-1 
            w-full h-[38vh] md:w-[280px] md:h-full 
            bg-slate-50 border-t md:border-t-0 md:border-r border-orange-200 
            flex flex-col z-20 shadow-[0_-5px_15px_-5px_rgba(0,0,0,0.1)] md:shadow-lg
            shrink-0 transition-all duration-300 ease-in-out
        ">
            <!-- Tabs -->
            <div class="flex p-2 gap-1 bg-slate-100 border-b border-slate-200 shrink-0">
                <button onclick="switchTab('molecules')" id="tab-molecules" class="tab-btn active">Molecules</button>
                <button onclick="switchTab('enzymes')" id="tab-enzymes" class="tab-btn">Enzymes</button>
                <button onclick="switchTab('pathways')" id="tab-pathways" class="tab-btn">Pathways</button>
            </div>

            <!-- Search -->
            <div class="px-3 py-2 bg-white border-b border-slate-100 shrink-0">
                <input type="text" id="search-bar" placeholder="Search..."
                    class="w-full px-3 py-1.5 text-sm bg-slate-50 border border-slate-200 rounded-lg focus:outline-none focus:border-orange-400 focus:bg-white transition-colors text-slate-600">
            </div>

            <!-- List Container -->
            <div id="inventory-list" class="flex-1 inventory-scroll p-2 grid grid-cols-1 gap-2 content-start pb-8">
                <!-- Items injected here -->
            </div>
        </aside>

    </div>

    <!-- Disclaimer Modal -->
    <div id="disclaimer-modal"
        class="fixed inset-0 z-[10000] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full text-center border-4 border-orange-200">
            <h2 class="text-xl font-bold text-orange-800 mb-4">Disclaimer</h2>
            <p class="text-slate-600 text-sm mb-6 leading-relaxed text-justify max-h-[50vh] overflow-y-auto">
                The metabolic pathways and biochemical processes in this platform are simplified for educational
                purposes and may not fully reflect real biochemical mechanisms. For accurate and detailed information,
                please refer to authoritative textbooks and academic resources.
            </p>
            <button onclick="closeDisclaimer()"
                class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-xl transition shadow-lg shadow-orange-500/30 text-sm w-full">
                Understand
            </button>
        </div>
    </div>

    <!-- Main Menu Modal -->
    <div id="main-menu-modal"
        class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-orange-50/90 backdrop-blur-sm">
        <div class="max-w-md w-full p-6 flex flex-col gap-4 animate-[fadeIn_0.5s_ease-out]">
            <div class="text-center mb-4">
                <div
                    class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center text-white text-3xl font-bold mx-auto mb-3 shadow-lg">
                    LB</div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-wide">Little Biochemist</h1>
                <p class="text-slate-500 text-sm">Choose your mode</p>
            </div>

            <button onclick="GameManager.startGame('sandbox')"
                class="group relative bg-white p-4 rounded-xl border-2 border-slate-200 hover:border-green-400 transition-all shadow-sm hover:shadow-md text-left">
                <div class="font-bold text-slate-800 text-lg group-hover:text-green-600">üß™ Sandbox Mode</div>
                <div class="text-xs text-slate-500 mt-1">Free exploration. Check out all molecules and enzymes without
                    restrictions.</div>
            </button>

            <button onclick="openTopicSelect()"
                class="group relative bg-white p-4 rounded-xl border-2 border-slate-200 hover:border-purple-400 transition-all shadow-sm hover:shadow-md text-left">
                <div class="font-bold text-slate-800 text-lg group-hover:text-purple-600">üéì Campaign Beta</div>
                <div class="text-xs text-slate-500 mt-1">Structured learning. Complete objectives to unlock new
                    metabolic concepts.</div>
            </button>
        </div>
    </div>

    <!-- Topic Selection Modal -->
    <div id="topic-select-modal"
        class="hidden fixed inset-0 z-[9999] flex items-center justify-center bg-purple-50/95 backdrop-blur-sm p-4">
        <div
            class="max-w-2xl w-full bg-white rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh] border border-purple-100">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-purple-50/50">
                <h2 class="text-xl font-bold text-purple-900">Select a Topic</h2>
                <button onclick="showMainMenu()"
                    class="text-xs font-bold text-slate-400 hover:text-slate-600 uppercase tracking-wider">Back</button>
            </div>

            <div id="topic-list" class="flex-1 overflow-y-auto p-4 grid grid-cols-1 gap-3">
                <!-- Topics Injected Here -->
            </div>
        </div>
    </div>

    <!-- Drag Layer -->
    <div id="drag-layer" class="fixed inset-0 pointer-events-none z-[9999]"></div>

    <script>
        function createBicarbonate(id, l) { return wrapIcon(id, `${svgStart(50, 40)}<circle cx="25" cy="20" r="5" class="atom-c"/><circle cx="25" cy="10" r="4" class="atom-o"/><circle cx="15" cy="27" r="4" class="atom-o"/><circle cx="35" cy="27" r="4" class="atom-o"/></svg>`, l); }
        function createMethylmalonylCoA(id, l) { return wrapIcon(id, `${svgStart(75, 50)}<rect x="45" y="15" width="25" height="18" rx="4" fill="#94a3b8"/><text x="57" y="28" font-size="8" fill="white" text-anchor="middle">CoA</text><line x1="35" y1="24" x2="45" y2="24" stroke="#333" stroke-width="2"/><circle cx="5" cy="24" r="5" class="atom-c"/><circle cx="15" cy="24" r="5" class="atom-c"/><circle cx="25" cy="24" r="5" class="atom-c"/><circle cx="35" cy="24" r="5" class="atom-c"/><circle cx="25" cy="14" r="5" class="atom-c" stroke="#333" stroke-width="1"/></svg>`, l || 'Methylmalonyl-CoA'); }

        // --- DATA ---
        const ELEMENTS = {
            // --- MOLECULES ---
            'triglyceride': { name: 'Triglyceride', category: 'molecules', chainLength: 99, desc: 'Lipid storage', render: (id, label) => createTAG(id, label) },
            'monoacylglycerol': { name: 'Monoacylglycerol', category: 'molecules', desc: 'Glycerol + 1 FA.', render: (id, label) => createMAG(id, label) },
            'diacylglycerol': { name: 'Diacylglycerol', category: 'molecules', desc: 'Glycerol + 2 FA.', render: (id, label) => createDAG(id, label) },
            'cholesteryl_ester': { name: 'Cholesteryl Ester', category: 'molecules', desc: 'Stored Cholesterol.', render: (id, label) => createCholesterylEster(id, label) },

            'glucose': { name: 'Glucose', category: 'molecules', desc: 'Major source of energy', render: (id, label) => createGlucose(id, label) },
            'pyruvate': { name: 'Pyruvate', category: 'molecules', desc: 'End product of glycolysis', render: (id, label) => createPyruvate(id, label) },
            'succinyl_coa': { name: 'Succinyl-CoA', category: 'molecules', desc: 'Intermediate of TCA cycle', render: (id, label) => createSuccinylCoA(id, label) },
            'succinate': { name: 'Succinate', category: 'molecules', desc: 'Intermediate of TCA cycle', render: (id, label) => createSuccinate(id, label) },
            'citrate': { name: 'Citrate', category: 'molecules', desc: 'Intermediate of TCA cycle', render: (id, label) => createCitrate(id, label) },
            'oaa': { name: 'Oxaloacetate', category: 'molecules', desc: 'TCA acceptor.', render: (id, label) => createOAA(id, label) },
            'malate': { name: 'Malate', category: 'molecules', desc: 'Intermediate of TCA cycle', render: (id, label) => createMalate(id, label) },
            'amp': { name: 'AMP', category: 'molecules', desc: 'Adenosine monophosphate', render: (id, label) => createMoleculeSmall(id, 'AMP', '#94a3b8') },
            'adp': { name: 'ADP', category: 'molecules', desc: 'Adenosine diphosphate', render: (id, label) => createMoleculeSmall(id, 'ADP', '#fbbf24') },
            'nad': { name: 'NAD+', category: 'molecules', desc: 'Oxidizing agent', render: (id, label) => createMoleculeSmall(id, 'NAD+', '#8b5cf6') },
            'water': { name: 'Water', category: 'molecules', desc: 'H2O.', render: (id, label) => createMoleculeSmall(id, 'H2O', '#3b82f6') },
            'acetone': { name: 'Acetone', category: 'molecules', desc: 'Volatile ketone body', render: (id, label) => createAcetone(id, label) },

            'fatty_acid': { name: 'Fatty Acid', category: 'molecules', chainLength: 0, desc: 'Generic long chain fatty acid', render: (id, label) => createFattyAcid(id, 4, label) },

            // Saturated Fatty Acids (Even)
            'stearic_acid': { name: 'Stearic Acid (18:0)', category: 'molecules', chainLength: 18, desc: 'Saturated fatty acid', render: (id, label) => createFattyAcid(id, 9, label) },
            'palmitic_acid': { name: 'Palmitic Acid (16:0)', category: 'molecules', chainLength: 16, desc: 'Saturated fatty acid', render: (id, label) => createFattyAcid(id, 8, label) },
            'myristic_acid': { name: 'Myristic Acid (14:0)', category: 'molecules', chainLength: 14, desc: 'Saturated fatty acid', render: (id, label) => createFattyAcid(id, 7, label) },
            'lauric_acid': { name: 'Lauric Acid (12:0)', category: 'molecules', chainLength: 12, desc: 'Saturated fatty acid', render: (id, label) => createFattyAcid(id, 6, label) },
            'capric_acid': { name: 'Capric Acid (10:0)', category: 'molecules', chainLength: 10, desc: 'Saturated fatty acid', render: (id, label) => createFattyAcid(id, 5, label) },
            'caprylic_acid': { name: 'Caprylic Acid (8:0)', category: 'molecules', chainLength: 8, desc: 'Saturated fatty acid', render: (id, label) => createFattyAcid(id, 4, label) },
            'caproic_acid': { name: 'Caproic Acid (6:0)', category: 'molecules', chainLength: 6, desc: 'Saturated fatty acid', render: (id, label) => createFattyAcid(id, 3, label) },
            'butyric_acid': { name: 'Butyric Acid (4:0)', category: 'molecules', chainLength: 4, desc: 'Saturated fatty acid', render: (id, label) => createFattyAcid(id, 2, label) },

            // Odd Chain Fatty Acids
            'pentadecanoic_acid': { name: 'Pentadecanoic (15:0)', category: 'molecules', chainLength: 15, desc: 'Odd-chain fatty acid', render: (id, label) => createFattyAcid(id, 7, label) },
            'tridecanoic_acid': { name: 'Tridecanoic (13:0)', category: 'molecules', chainLength: 13, desc: 'Odd-chain fatty acid', render: (id, label) => createFattyAcid(id, 6, label) },
            'undecanoic_acid': { name: 'Undecanoic (11:0)', category: 'molecules', chainLength: 11, desc: 'Odd-chain fatty acid', render: (id, label) => createFattyAcid(id, 5, label) },
            'nonanoic_acid': { name: 'Nonanoic (9:0)', category: 'molecules', chainLength: 9, desc: 'Odd-chain fatty acid', render: (id, label) => createFattyAcid(id, 4, label) },
            'heptanoic_acid': { name: 'Heptanoic (7:0)', category: 'molecules', chainLength: 7, desc: 'Odd-chain fatty acid', render: (id, label) => createFattyAcid(id, 3, label) },
            'valeric_acid': { name: 'Valeric (5:0)', category: 'molecules', chainLength: 5, desc: 'Odd-chain fatty acid', render: (id, label) => createFattyAcid(id, 2, label) },
            'propionic_acid': { name: 'Propionic (3:0)', category: 'molecules', chainLength: 3, desc: 'Odd-chain fatty acid', render: (id, label) => createFattyAcid(id, 1, label) },

            'glycerol': { name: 'Glycerol', category: 'molecules', desc: 'Lipid backbone.', render: (id, label) => createGlycerol(id, label) },

            // Acyl-CoAs (Activated Fatty Acids)
            'acyl_coa': { name: 'Acyl-CoA', category: 'molecules', chainLength: 0, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Acyl-CoA') },

            // Even Chain Activated
            'acyl_coa_18': { name: 'Stearoyl-CoA (C18)', category: 'molecules', chainLength: 18, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Stearoyl-CoA (C18)') },
            'acyl_coa_16': { name: 'Palmitoyl-CoA (C16)', category: 'molecules', chainLength: 16, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Palmitoyl-CoA (C16)') },
            'acyl_coa_14': { name: 'Myristoyl-CoA (C14)', category: 'molecules', chainLength: 14, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Myristoyl-CoA (C14)') },
            'acyl_coa_12': { name: 'Lauroyl-CoA (C12)', category: 'molecules', chainLength: 12, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Lauroyl-CoA (C12)') },
            'acyl_coa_10': { name: 'Decanoyl-CoA (C10)', category: 'molecules', chainLength: 10, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Decanoyl-CoA (C10)') },
            'acyl_coa_8': { name: 'Octanoyl-CoA (C8)', category: 'molecules', chainLength: 8, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Octanoyl-CoA (C8)') },
            'acyl_coa_6': { name: 'Hexanoyl-CoA (C6)', category: 'molecules', chainLength: 6, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Hexanoyl-CoA (C6)') },
            'acyl_coa_4': { name: 'Butyryl-CoA (C4)', category: 'molecules', chainLength: 4, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Butyryl-CoA (C4)') },

            // Odd Chain Activated
            'acyl_coa_15': { name: 'Pentadecanoyl-CoA (C15)', category: 'molecules', chainLength: 15, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Pentadecanoyl-CoA (C15)') },
            'acyl_coa_13': { name: 'Tridecanoyl-CoA (C13)', category: 'molecules', chainLength: 13, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Tridecanoyl-CoA (C13)') },
            'acyl_coa_11': { name: 'Undecanoyl-CoA (C11)', category: 'molecules', chainLength: 11, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Undecanoyl-CoA (C11)') },
            'acyl_coa_9': { name: 'Nonanoyl-CoA (C9)', category: 'molecules', chainLength: 9, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Nonanoyl-CoA (C9)') },
            'acyl_coa_7': { name: 'Heptanoyl-CoA (C7)', category: 'molecules', chainLength: 7, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Heptanoyl-CoA (C7)') },
            'acyl_coa_5': { name: 'Valeroyl-CoA (C5)', category: 'molecules', chainLength: 5, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Valeroyl-CoA (C5)') },
            'acyl_coa_3': { name: 'Propanoyl-CoA (C3)', category: 'molecules', chainLength: 3, desc: 'Activated fatty acid', render: (id, label) => createAcylCoA(id, label || 'Propanoyl-CoA (C3)') },

            'acetyl_coa': { name: 'Acetyl-CoA', category: 'molecules', desc: 'Central metabolic hub (2C)', render: (id, label) => createAcetylCoA(id, label) },
            'acetoacetyl_coa': { name: 'Acetoacetyl-CoA', category: 'molecules', desc: 'The precursor of HMG-CoA', render: (id, label) => createAcetoAcetylCoA(id, label) },
            'hmg_coa': { name: 'HMG-CoA', category: 'molecules', desc: 'Intermediate of cholesterol and ketones', render: (id, label) => createHMGCoA(id, label) },
            'ketone_body': { name: 'Acetoacetate', category: 'molecules', desc: 'Ketone body', render: (id, label) => createKetone(id, label) },
            '3_hydroxybutyrate': { name: '3-Hydroxybutyrate', category: 'molecules', desc: 'Ketone body', render: (id, label) => create3HB(id, label) },
            'mevalonate': { name: 'Mevalonate', category: 'molecules', desc: 'Cholesterol step.', render: (id, label) => createMevalonate(id, label) },
            'cholesterol': { name: 'Cholesterol', category: 'molecules', desc: 'Steroid.', render: (id, label) => createCholesterol(id, label) },
            'malonyl_coa': { name: 'Malonyl-CoA', category: 'molecules', desc: 'Synthesis block.', render: (id, label) => createMalonylCoA(id, label) },

            'atp': { name: 'ATP', category: 'molecules', desc: 'Adenosine triphosphate', render: (id, label) => createMoleculeSmall(id, 'ATP', '#eab308') },
            'co2': { name: 'CO2', category: 'molecules', desc: 'Carbon dioxide', render: (id, label) => createMoleculeSmall(id, 'CO2', '#64748b') },
            'nadph': { name: 'NADPH', category: 'molecules', desc: 'Reducing agent', render: (id, label) => createMoleculeSmall(id, 'NADPH', '#f472b6') },
            'nadh': { name: 'NADH', category: 'molecules', desc: 'Electron carrier.', render: (id, label) => createMoleculeSmall(id, 'NADH', '#8b5cf6') },
            'fadh2': { name: 'FADH2', category: 'molecules', desc: 'Electron carrier.', render: (id, label) => createMoleculeSmall(id, 'FADH2', '#8b5cf6') },
            'bicarbonate': { name: 'Bicarbonate', category: 'molecules', desc: 'HCO3-', render: (id, label) => createBicarbonate(id, label) },
            'methylmalonyl_coa': { name: 'Methylmalonyl-CoA', category: 'molecules', desc: 'Branched C4-CoA', render: (id, label) => createMethylmalonylCoA(id, label) },

            // --- ENZYMES ---
            'coa_transferase': { name: 'CoA Transferase', category: 'enzymes', desc: 'Transfer of coenzyme A', bg: '#fce7f3', border: '#db2777', requires: ['succinyl_coa', 'ketone_body'], produces: ['succinate', 'acetoacetyl_coa'] },
            'pyruvate_dehydrogenase': { name: 'Pyruvate Dehydrogenase', category: 'enzymes', desc: 'Produce Acetyl-CoA', bg: '#cffafe', border: '#0891b2', requires: ['pyruvate'], produces: ['acetyl_coa', 'nadh', 'co2'] },
            'citrate_synthase': { name: 'Citrate Synthase', category: 'enzymes', desc: 'Produce Citrate', bg: '#f0fdf4', border: '#16a34a', requires: ['acetyl_coa', 'oaa'], produces: ['citrate'] },
            'citrate_lyase': { name: 'Citrate Lyase', category: 'enzymes', desc: 'Produce OAA and Acetyl CoA', bg: '#f0fdf4', border: '#16a34a', requires: ['citrate'], produces: ['acetyl_coa', 'oaa'] },
            'malic_enzyme': { name: 'Malic Enzyme', category: 'enzymes', desc: 'Produce NADPH', bg: '#fae8ff', border: '#a21caf', requires: ['malate'], produces: ['pyruvate', 'nadph', 'co2'] },
            'acyltransferase': { name: 'Acyltransferase', category: 'enzymes', desc: 'Esterification of fatty acids', bg: '#ffedd5', border: '#c2410c', special: true, requires: [], produces: [] },
            'lipase': { name: 'Lipase', category: 'enzymes', desc: 'Generic lipase hydrolyse lipids', bg: '#fef3c7', border: '#d97706', special: true, requires: [], produces: [] },
            'acyl_synthetase': { name: 'Acyl-CoA Synthetase', category: 'enzymes', desc: 'Activate FA.', bg: '#ffedd5', border: '#c2410c', special: true, requires: ['atp'], produces: ['amp'] },
            'thiolase': { name: 'Thiolase', category: 'enzymes', desc: 'Cleavage/condensation', bg: '#e0e7ff', border: '#4338ca', special: true, requires: [], produces: [] },
            'hmg_synthase': { name: 'HMG-CoA Synthase', category: 'enzymes', desc: 'Produce HMG Co-A', bg: '#fae8ff', border: '#86198f', requires: ['acetoacetyl_coa', 'acetyl_coa'], produces: ['hmg_coa'] },
            'hmg_lyase': { name: 'HMG-CoA Lyase', category: 'enzymes', desc: 'Produce Ketone bodies', bg: '#d1fae5', border: '#059669', requires: ['hmg_coa'], produces: ['ketone_body', 'acetyl_coa'] },
            'hmg_reductase': { name: 'HMG-CoA Reductase', category: 'enzymes', desc: 'Produce Mevalonate', bg: '#fce7f3', border: '#db2777', requires: ['hmg_coa'], produces: ['mevalonate'] },
            '3hb_dehydrogenase': { name: '3-HB Dehydrogenase', category: 'enzymes', desc: 'Ketone Redox.', bg: '#ccfbf1', border: '#14b8a6', special: true, requires: [], produces: [] },
            'acc': { name: 'Acetyl-CoA Carboxylase', category: 'enzymes', desc: 'Produce Malanyl-coA', bg: '#ecfccb', border: '#65a30d', requires: ['acetyl_coa', 'bicarbonate', 'atp'], produces: ['malonyl_coa', 'adp'] },
            'fas': { name: 'Fatty Acid Synthase', category: 'enzymes', desc: 'Multienzymatic complex', bg: '#dcfce7', border: '#15803d', special: true, requires: ['malonyl_coa', 'nadph'], produces: [] },
            'pyruvate_carboxylase': { name: 'Pyruvate Carboxylase', category: 'enzymes', desc: 'Replenishes OAA.', bg: '#fefce8', border: '#ca8a04', requires: ['pyruvate', 'bicarbonate', 'atp'], produces: ['oaa', 'adp'] },
            'malate_dehydrogenase': { name: 'Malate Dehydrogenase', category: 'enzymes', desc: 'Reversible conversion.', bg: '#e0f2fe', border: '#0284c7', special: true, requires: [], produces: [] },
            'propionyl_coa_carboxylase': { name: 'Propionyl-CoA Carboxylase', category: 'enzymes', desc: 'Propionate breakdown', bg: '#ecfccb', border: '#65a30d', requires: ['acyl_coa_3', 'bicarbonate', 'atp'], produces: ['methylmalonyl_coa', 'adp'] },
            'methylmalonyl_coa_mutase': { name: 'Methylmalonyl-CoA Mutase', category: 'enzymes', desc: 'Isomerization to Succinyl-CoA', bg: '#e0e7ff', border: '#4338ca', requires: ['methylmalonyl_coa'], produces: ['succinyl_coa'] },

            // --- PATHWAYS ---
            'glycolysis': { name: 'Glycolysis', category: 'pathways', desc: 'Glucose Breakdown.', bg: '#dbeafe', border: '#1d4ed8', requires: ['glucose'], produces: ['pyruvate', 'pyruvate', 'nadh', 'nadh', 'atp'] },
            'etc': { name: 'Electron Transport Chain', category: 'pathways', desc: 'Oxidative phosphorylation', bg: '#e0e7ff', border: '#4338ca', special: true, requires: [], produces: [] },
            'beta_oxidation': { name: 'Beta-Oxidation', category: 'pathways', desc: 'Major pathway to breakdown FA', bg: '#ffedd5', border: '#c2410c', special: true, requires: [], produces: ['acetyl_coa', 'nadh', 'fadh2'] },
            'cholesterol_synth': { name: 'Cholesterol Pathway', category: 'pathways', desc: 'Multi steps process', bg: '#fdf2f8', border: '#be185d', requires: ['mevalonate', 'atp'], produces: ['cholesterol'] },
            'tca_cycle': { name: 'TCA Cycle', category: 'pathways', desc: 'Citric acid cycle/Krebs cycle', bg: '#f3f4f6', border: '#475569', requires: ['acetyl_coa'], produces: ['co2', 'co2', 'atp', 'fadh2', 'nadh', 'nadh', 'nadh'] },
            'spontaneous_pathway': { name: 'Spontaneous', category: 'pathways', desc: 'A reaction that occur by itself', bg: '#fef2f2', border: '#ef4444', requires: ['ketone_body'], produces: ['acetone', 'co2'] }
        };

        // --- STATE ---
        let currentTab = 'molecules';
        let workbenchItems = [];
        let nextId = 0;

        // Drag State
        let dragState = {
            active: false,
            item: null, // The data object
            element: null, // The visual DOM element
            source: 'workbench',
            dropTargets: [], // Cached targets for better performance
            trashRect: null,
            startX: 0,
            startY: 0,
            initialLeft: 0,
            initialTop: 0,
            currentX: 0,
            currentY: 0,
            rafId: null
        };

        // --- GAME MANAGER (Campaign Logic) ---
        const GameManager = {
            mode: 'sandbox', // 'sandbox' | 'campaign'
            currentTopicIndex: 0,
            topics: [
                {
                    id: 'lipolysis',
                    title: 'Lipolysis',
                    objective: 'Break down Triglyceride into Glycerol + 3 Fatty Acids.',
                    desc: 'Lipolysis is the breakdown of fats (triglycerides) by hydrolysis to release fatty acids.',
                    allowedInventory: ['molecules', 'triglyceride', 'enzymes', 'lipase'],
                    startItems: [
                        { elemId: 'triglyceride', x: 0, y: 0 },
                        { elemId: 'lipase', x: 100, y: 0 }
                    ],
                    checkWin: () => {
                        // Win if 1 Glycerol and >= 3 Fatty Acids exist (Count generic fatty_acid too)
                        const glycerol = workbenchItems.filter(i => i.elemId === 'glycerol').length;
                        const fas = workbenchItems.filter(i => i.elemId === 'fatty_acid' || (ELEMENTS[i.elemId].chainLength > 0 && ELEMENTS[i.elemId].category === 'molecules')).length;
                        return glycerol >= 1 && fas >= 3;
                    }
                },
                {
                    id: 'activation',
                    title: 'Activation',
                    objective: 'Activate a Fatty Acid into Acyl-CoA.',
                    desc: 'Before oxidation, fatty acids must be activated with Coenzyme A.',
                    allowedInventory: ['molecules', 'palmitic_acid', 'atp', 'enzymes', 'acyl_synthetase'],
                    startItems: [
                        { elemId: 'palmitic_acid', x: -50, y: 0 },
                        { elemId: 'atp', x: 50, y: 0 },
                        { elemId: 'acyl_synthetase', x: 0, y: 100 }
                    ],
                    checkWin: () => {
                        return workbenchItems.some(i => i.elemId.startsWith('acyl_coa'));
                    }
                },
                {
                    id: 'beta_oxidation',
                    title: 'Beta-Oxidation',
                    objective: 'Perform Beta-Oxidation on Acyl-CoA.',
                    desc: 'The cycle cleaves two carbons at a time to produce Acetyl-CoA.',
                    allowedInventory: ['molecules', 'acyl_coa_16', 'enzymes', 'pathways', 'beta_oxidation'],
                    startItems: [
                        { elemId: 'acyl_coa_16', x: -50, y: 0 },
                        { elemId: 'beta_oxidation', x: 50, y: 0 }
                    ],
                    checkWin: () => {
                        // Win if Acetyl-CoA is produced >= 8
                        const ac = workbenchItems.filter(i => i.elemId === 'acetyl_coa').length;
                        return ac >= 8;
                    }
                },
                {
                    id: 'ketogenesis',
                    title: 'Ketogenesis',
                    objective: 'Produce a Ketone Body (Acetoacetate).',
                    desc: 'Excess Acetyl-CoA is converted to ketone bodies in the liver.',
                    allowedInventory: ['molecules', 'acetyl_coa', 'enzymes', 'hmg_synthase', 'hmg_lyase', 'atp', 'thiolase', '3hb_dehydrogenase', 'pathways', 'spontaneous_pathway'],
                    startItems: [
                        { elemId: 'acetyl_coa', x: -80, y: 0 },
                        { elemId: 'acetyl_coa', x: 0, y: 0 },
                        { elemId: 'acetyl_coa', x: 80, y: 0 },
                        { elemId: 'thiolase', x: 0, y: 80 },
                        { elemId: 'hmg_synthase', x: -60, y: 180 },
                        { elemId: 'hmg_lyase', x: 60, y: 180 }
                    ],
                    checkWin: () => {
                        // Originally 'ketone_body' is Acetoacetate. User asked for "acetoneacetate" (typo?) -> 'ketone_body'
                        // Just check for 'ketone_body' specifically.
                        return workbenchItems.some(i => i.elemId === 'ketone_body');
                    }
                }
            ],

            checkLoop: null,

            init: function () {
                // Determine if there is a saved mode? (Local storage in future)
                // For now start in Sandbox
            },

            startGame: function (mode) {
                document.getElementById('main-menu-modal').classList.add('hidden');
                document.getElementById('topic-select-modal').classList.add('hidden');
                this.setMode(mode);
            },

            loadTopicAndStart: function (index) {
                this.startGame('campaign');
                this.loadTopic(index);
            },

            returnToMenu: function () {
                // Clear any running game loop or state if needed
                document.getElementById('topic-complete-modal').classList.add('hidden');
                showMainMenu();
            },

            stayOnWorkbench: function () {
                document.getElementById('topic-complete-modal').classList.add('hidden');
                // Stop checking win condition so it doesn't pop up again immediately?
                // Or just let it be. If they change state it might un-win. 
                // Better to clear interval to prevent spam.
                if (this.checkLoop) clearInterval(this.checkLoop);
            },

            setMode: function (newMode) {
                this.mode = newMode;
                const badge = document.getElementById('mode-badge');
                const hud = document.getElementById('campaign-hud');
                const tutorial = document.getElementById('tutorial-msg');

                if (newMode === 'campaign') {
                    badge.innerText = 'CAMPAIGN BETA';
                    badge.className = "text-[10px] text-purple-700 bg-purple-100 border border-purple-200 px-2 py-0.5 rounded-full font-bold tracking-wider w-fit cursor-pointer hover:bg-purple-200 transition";
                    hud.classList.remove('hidden');
                    tutorial.classList.add('hidden'); // Force hide tutorial in campaign
                    this.loadTopic(0);
                    // Start Win Check Loop
                    if (this.checkLoop) clearInterval(this.checkLoop);
                    this.checkLoop = setInterval(() => this.checkWinCondition(), 1000);
                } else {
                    badge.innerText = 'LIPID SANDBOX';
                    badge.className = "text-[10px] text-green-700 bg-green-100 border border-green-200 px-2 py-0.5 rounded-full font-bold tracking-wider w-fit cursor-pointer hover:bg-green-200 transition";
                    hud.classList.add('hidden');
                    // tutorial.classList.remove('hidden'); // Maybe?
                    workbenchItems = [];
                    renderWorkbench();
                    renderInventory(); // Show all
                    if (this.checkLoop) clearInterval(this.checkLoop);
                }
            },

            loadTopic: function (index) {
                if (index >= this.topics.length) {
                    alert("Campaign Completed! Back to Sandbox.");
                    this.returnToMenu();
                    return;
                }
                this.currentTopicIndex = index;
                const topic = this.topics[index];

                // update UI
                document.getElementById('topic-title').innerText = `TOPIC ${index + 1}: ${topic.title}`;
                document.getElementById('topic-objective').innerText = topic.objective;
                document.getElementById('topic-complete-modal').classList.add('hidden');

                // Clear and Setup Workbench
                workbenchItems = [];
                // Center items logic could be improved, but for now fixed offsets
                const wb = document.getElementById('workbench');
                const wbRect = wb.getBoundingClientRect();
                const centerX = wbRect.width / 2;
                const centerY = wbRect.height / 2;

                // Scale factor for smaller screens (baseline 1200px width for tighter grouping)
                const scale = Math.min(1, wbRect.width / 1200);

                topic.startItems.forEach(item => {
                    spawnItemSpecific(item.elemId, centerX + (item.x * scale), centerY + (item.y * scale));
                });

                renderWorkbench();
                renderInventory(); // Will filter based on topic
            },

            nextTopic: function () {
                this.loadTopic(this.currentTopicIndex + 1);
            },

            checkWinCondition: function () {
                if (this.mode !== 'campaign') return;
                const topic = this.topics[this.currentTopicIndex];
                if (topic.checkWin()) {
                    // Show Win Modal
                    document.getElementById('topic-complete-modal').classList.remove('hidden');
                }
            }
        };

        function toggleGameMode() {
            // Instead of toggle, go to menu
            showMainMenu();
        }

        // Helper to spawn at specific location
        function spawnItemSpecific(elemId, x, y) {
            const uid = 'obj-' + (nextId++);
            const newItem = {
                id: uid,
                elemId: elemId,
                type: ELEMENTS[elemId].category === 'molecules' ? 'molecule' : 'enzyme',
                x: x,
                y: y,
                contents: []
            };
            workbenchItems.push(newItem);
        }

        // Modify renderInventory to support filtering
        function renderInventory(filter = "") {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';

            const term = filter.toLowerCase();
            let keys = Object.keys(ELEMENTS).filter(key => {
                const item = ELEMENTS[key];

                // Campaign Filter
                if (GameManager.mode === 'campaign') {
                    const topic = GameManager.topics[GameManager.currentTopicIndex];
                    // Check if item is allowed. 
                    // We allow categories (e.g. 'molecules') to imply all, but here we likely want specific items
                    // Strategy: allowedInventory contains 'categoryName' (allow all in category) OR 'itemId'
                    if (!topic.allowedInventory.includes(item.category) && !topic.allowedInventory.includes(key)) {
                        return false;
                    }
                }

                if (item.category !== currentTab) return false;
                if (term && !item.name.toLowerCase().includes(term)) return false;
                return true;
            });



            // Sort
            keys.sort((a, b) => {
                const itemA = ELEMENTS[a];
                const itemB = ELEMENTS[b];
                const getLength = (item, id) => {
                    if (item.chainLength) return item.chainLength;
                    const match = id.match(/_(\d+)$/);
                    return match ? parseInt(match[1]) : 0;
                };
                const lenA = getLength(itemA, a);
                const lenB = getLength(itemB, b);
                if (lenA > 0 && lenB > 0) return lenB - lenA;
                return itemA.name.localeCompare(itemB.name);
            });

            keys.forEach(key => {
                const item = ELEMENTS[key];
                const div = document.createElement('div');
                div.className = 'inventory-item p-3 rounded-xl flex items-center gap-3 border border-orange-100 bg-white shadow-sm relative cursor-pointer active:scale-95 select-none hover:bg-orange-50';
                div.dataset.elemId = key;

                let iconHTML = item.category === 'molecules'
                    ? `<div class="w-10 h-10 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-xs font-bold text-slate-500 shrink-0">${item.name.substring(0, 2)}</div>`
                    : `<div class="w-10 h-10 rounded bg-slate-50 border border-dashed border-slate-400 flex items-center justify-center text-xs shrink-0">‚öôÔ∏è</div>`;

                div.innerHTML = `
                    ${iconHTML}
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-bold text-slate-700 truncate">${item.name}</div>
                        <div class="text-[10px] text-slate-400 truncate">${item.desc}</div>
                    </div>
                `;

                // Click to spawn instead of Drag
                div.onclick = () => spawnItemFromInventory(key);
                list.appendChild(div);
            });
        }

        function init() {
            renderInventory();

            document.getElementById('search-bar').addEventListener('input', (e) => {
                renderInventory(e.target.value);
            });

            // Global Events for Dragging
            document.addEventListener('mousedown', handleGlobalStart);
            document.addEventListener('touchstart', handleGlobalStart, { passive: false });

            document.addEventListener('mousemove', handleGlobalMove);
            document.addEventListener('touchmove', handleGlobalMove, { passive: false });

            document.addEventListener('mouseup', handleGlobalEnd);
            document.addEventListener('touchend', handleGlobalEnd);
        }

        // Need a renderWorkbench to refresh DOM from state (for level loads)
        function renderWorkbench() {
            const wb = document.getElementById('workbench');
            // Keep the static elements (text, bin, tutorial)
            // Strategy: Remove all 'molecule' class items
            const existing = wb.querySelectorAll('.molecule');
            existing.forEach(e => e.remove());

            // Re-add from workbenchItems
            workbenchItems.forEach(item => {
                const div = document.createElement('div');
                div.innerHTML = item.type === 'enzyme' ? createEnzymeBox(item.id, item.elemId) : ELEMENTS[item.elemId].render(item.id, ELEMENTS[item.elemId].name);
                const el = div.firstElementChild;
                el.style.position = 'absolute';
                el.style.left = item.x + 'px';
                el.style.top = item.y + 'px';
                wb.appendChild(el);
            });
        }

        function closeDisclaimer() {
            document.getElementById('disclaimer-modal').style.display = 'none';
            showMainMenu();
        }

        function showMainMenu() {
            document.getElementById('main-menu-modal').classList.remove('hidden');
            document.getElementById('topic-select-modal').classList.add('hidden');
        }

        function openTopicSelect() {
            document.getElementById('main-menu-modal').classList.add('hidden');
            document.getElementById('topic-select-modal').classList.remove('hidden');
            renderTopicList();
        }

        function renderTopicList() {
            const list = document.getElementById('topic-list');
            list.innerHTML = '';
            GameManager.topics.forEach((topic, index) => {
                const btn = document.createElement('button');
                btn.className = "text-left p-4 rounded-xl border border-slate-200 hover:border-purple-400 hover:bg-purple-50 transition-all group relative";
                btn.onclick = () => GameManager.loadTopicAndStart(index);
                btn.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs font-bold text-purple-400 bg-purple-100 px-2 py-0.5 rounded-md">TOPIC ${index + 1}</span>
                    </div>
                    <div class="text-lg font-bold text-slate-800 group-hover:text-purple-700">${topic.title}</div>
                    <div class="text-sm text-slate-500 mt-1">${topic.desc}</div>
                `;
                list.appendChild(btn);
            });
        }

        function resetGame() {
            if (GameManager.mode === 'campaign') {
                GameManager.loadTopic(GameManager.currentTopicIndex);
                return;
            }
            resetSandbox();
        }

        function resetSandbox() {
            workbenchItems = [];
            renderWorkbench();
            const tutorial = document.getElementById('tutorial-msg');
            if (tutorial) tutorial.classList.remove('hidden');
        }

        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active');
                if (b.id === 'tab-' + tabName) b.classList.add('active');
            });
            renderInventory();
        }

        // --- RENDER INVENTORY ---
        function renderInventory(filter = "") {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';

            const term = filter.toLowerCase();
            let keys = Object.keys(ELEMENTS).filter(key => {
                const item = ELEMENTS[key];
                if (item.category !== currentTab) return false;
                if (term && !item.name.toLowerCase().includes(term)) return false;
                return true;
            });

            // Sort
            keys.sort((a, b) => {
                const itemA = ELEMENTS[a];
                const itemB = ELEMENTS[b];
                const getLength = (item, id) => {
                    if (item.chainLength) return item.chainLength;
                    const match = id.match(/_(\d+)$/);
                    return match ? parseInt(match[1]) : 0;
                };
                const lenA = getLength(itemA, a);
                const lenB = getLength(itemB, b);
                if (lenA > 0 && lenB > 0) return lenB - lenA;
                return itemA.name.localeCompare(itemB.name);
            });

            keys.forEach(key => {
                const item = ELEMENTS[key];
                const div = document.createElement('div');
                div.className = 'inventory-item p-3 rounded-xl flex items-center gap-3 border border-orange-100 bg-white shadow-sm relative cursor-pointer active:scale-95 select-none hover:bg-orange-50';
                div.dataset.elemId = key;

                let iconHTML = item.category === 'molecules'
                    ? `<div class="w-10 h-10 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-xs font-bold text-slate-500 shrink-0">${item.name.substring(0, 2)}</div>`
                    : `<div class="w-10 h-10 rounded bg-slate-50 border border-dashed border-slate-400 flex items-center justify-center text-xs shrink-0">‚öôÔ∏è</div>`;

                div.innerHTML = `
                    ${iconHTML}
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-bold text-slate-700 truncate">${item.name}</div>
                        <div class="text-[10px] text-slate-400 truncate">${item.desc}</div>
                    </div>
                `;

                // Click to spawn instead of Drag
                div.onclick = () => spawnItemFromInventory(key);
                list.appendChild(div);
            });
        }

        // --- SVG FACTORIES ---
        const svgStart = (w, h) => `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg" class="pointer-events-none block">`;

        function createGenericMolecule(id, label, color) { return wrapIcon(id, `${svgStart(50, 50)}<circle cx="25" cy="25" r="15" fill="white" stroke="${color}" stroke-width="2"/></svg>`, label); }
        function createMoleculeSmall(id, label, color) { return wrapIcon(id, `${svgStart(50, 50)}<circle cx="25" cy="25" r="20" fill="${color}" fill-opacity="0.2" stroke="${color}" stroke-width="2"/><text x="25" y="29" font-size="10" font-weight="bold" fill="${color}" text-anchor="middle">${label}</text></svg>`, label); }
        function createGlucose(id, label) { return wrapIcon(id, `${svgStart(50, 50)}<polygon points="25,5 45,15 45,35 25,45 5,35 5,15" fill="none" stroke="#3b82f6" stroke-width="3" /></svg>`, label); }
        function createPyruvate(id, label) { return wrapIcon(id, `${svgStart(50, 50)}<circle cx="15" cy="25" r="6" class="atom-c"/><circle cx="25" cy="25" r="6" class="atom-c"/><circle cx="35" cy="25" r="6" class="atom-c"/></svg>`, label); }

        function createTAG(id, label) {
            return wrapIcon(id, `${svgStart(80, 80)}<path d="M10,10 L10,70" stroke="#94a3b8" stroke-width="6" stroke-linecap="round"/><path d="M10,20 L30,20 L35,25 L45,15 L55,25 L65,15 L70,20" class="lipid-stroke"/><path d="M10,40 L30,40 L35,45 L45,35 L55,45 L65,35 L70,40" class="lipid-stroke"/><path d="M10,60 L30,60 L35,65 L45,55 L55,65 L65,55 L70,60" class="lipid-stroke"/></svg>`, label || 'TAG');
        }
        function createDAG(id, label) { return wrapIcon(id, `${svgStart(80, 80)}<path d="M10,10 L10,70" stroke="#94a3b8" stroke-width="6" stroke-linecap="round"/><path d="M10,20 L30,20 L35,25 L45,15 L55,25 L65,15 L70,20" class="lipid-stroke"/><path d="M10,40 L30,40 L35,45 L45,35 L55,45 L65,35 L70,40" class="lipid-stroke"/></svg>`, label || 'DAG'); }
        function createMAG(id, label) { return wrapIcon(id, `${svgStart(80, 80)}<path d="M10,10 L10,70" stroke="#94a3b8" stroke-width="6" stroke-linecap="round"/><path d="M10,20 L30,20 L35,25 L45,15 L55,25 L65,15 L70,20" class="lipid-stroke"/></svg>`, label || 'MAG'); }

        function createFattyAcid(id, zigs, label) {
            let path = `M5,20 `;
            for (let i = 0; i < zigs; i++) path += `l10,-10 l10,10 `;
            return wrapIcon(id, `${svgStart(80, 40)}<path d="${path}" class="lipid-stroke" fill="none"/><circle cx="5" cy="20" r="4" fill="#ef4444"/></svg>`, label);
        }

        function createAcylCoA(id, label) {
            return wrapIcon(id, `${svgStart(80, 40)}<rect x="50" y="10" width="25" height="20" rx="4" fill="#ea580c"/><text x="62" y="24" font-size="8" fill="white" text-anchor="middle">CoA</text><path d="M5,20 L15,10 L25,30 L35,10 L45,30 L50,20" class="lipid-stroke"/></svg>`, label);
        }

        function createAcetylCoA(id, label) {
            return wrapIcon(id, `${svgStart(60, 40)}<rect x="30" y="10" width="25" height="20" rx="4" fill="#94a3b8"/><text x="42" y="24" font-size="8" fill="white" text-anchor="middle">CoA</text><line x1="15" y1="20" x2="30" y2="20" stroke="#333" stroke-width="2"/><circle cx="10" cy="20" r="5" class="atom-c"/><circle cx="20" cy="20" r="5" class="atom-c"/></svg>`, label || 'Acetyl-CoA');
        }

        // Helper Wrappers
        function createSuccinylCoA(id, l) { return wrapIcon(id, `${svgStart(75, 40)}<rect x="45" y="10" width="25" height="18" rx="4" fill="#94a3b8"/><text x="57" y="23" font-size="8" fill="white" text-anchor="middle">CoA</text><line x1="35" y1="19" x2="45" y2="19" stroke="#333" stroke-width="2"/><circle cx="5" cy="19" r="5" class="atom-c"/><circle cx="15" cy="19" r="5" class="atom-c"/><circle cx="25" cy="19" r="5" class="atom-c"/><circle cx="35" cy="19" r="5" class="atom-c"/><circle cx="35" cy="11" r="3" class="atom-o"/></svg>`, l); }
        function createSuccinate(id, l) { return wrapIcon(id, `${svgStart(60, 40)}<circle cx="15" cy="20" r="5" class="atom-c"/><circle cx="25" cy="20" r="5" class="atom-c"/><circle cx="35" cy="20" r="5" class="atom-c"/><circle cx="45" cy="20" r="5" class="atom-c"/></svg>`, l); }
        function createCitrate(id, l) { return wrapIcon(id, `${svgStart(60, 50)}<circle cx="10" cy="25" r="5" class="atom-c"/><circle cx="20" cy="25" r="5" class="atom-c"/><circle cx="30" cy="25" r="5" class="atom-c"/><circle cx="40" cy="25" r="5" class="atom-c"/><circle cx="50" cy="25" r="5" class="atom-c"/><circle cx="30" cy="15" r="5" class="atom-c"/></svg>`, l); }
        function createOAA(id, l) { return wrapIcon(id, `${svgStart(60, 40)}<circle cx="15" cy="25" r="5" class="atom-c"/><circle cx="25" cy="25" r="5" class="atom-c"/><circle cx="35" cy="25" r="5" class="atom-c"/><circle cx="45" cy="25" r="5" class="atom-c"/><circle cx="25" cy="15" r="4" class="atom-o"/></svg>`, l); }
        function createMalate(id, l) { return wrapIcon(id, `${svgStart(60, 40)}<circle cx="15" cy="25" r="5" class="atom-c"/><circle cx="25" cy="15" r="5" class="atom-c"/><circle cx="35" cy="25" r="5" class="atom-c"/><circle cx="45" cy="15" r="5" class="atom-c"/></svg>`, l); }
        function createGlycerol(id, l) { return wrapIcon(id, `${svgStart(40, 60)}<line x1="20" y1="10" x2="20" y2="50" stroke="#94a3b8" stroke-width="6" stroke-linecap="round"/><circle cx="20" cy="15" r="4" fill="white" stroke="#94a3b8" stroke-width="2"/><circle cx="20" cy="30" r="4" fill="white" stroke="#94a3b8" stroke-width="2"/><circle cx="20" cy="45" r="4" fill="white" stroke="#94a3b8" stroke-width="2"/></svg>`, l); }
        function createAcetoAcetylCoA(id, l) { return wrapIcon(id, `${svgStart(70, 40)}<rect x="40" y="10" width="25" height="20" rx="4" fill="#94a3b8"/><text x="52" y="24" font-size="8" fill="white" text-anchor="middle">CoA</text><circle cx="10" cy="20" r="5" class="atom-c"/><circle cx="20" cy="20" r="5" class="atom-c"/><circle cx="30" cy="20" r="5" class="atom-c"/><circle cx="40" cy="20" r="5" class="atom-c"/></svg>`, l); }
        function createHMGCoA(id, l) { return wrapIcon(id, `${svgStart(70, 50)}<rect x="40" y="25" width="25" height="15" rx="4" fill="#94a3b8"/><text x="52" y="35" font-size="7" fill="white" text-anchor="middle">CoA</text><path d="M20,30 L40,30 M20,30 L20,15 L30,5" stroke="#333" stroke-width="2"/><circle cx="20" cy="30" r="5" class="atom-c"/><circle cx="30" cy="30" r="5" class="atom-c"/><circle cx="40" cy="30" r="5" class="atom-c"/><circle cx="20" cy="15" r="5" class="atom-c"/><circle cx="30" cy="5" r="5" fill="#ec4899"/></svg>`, l); }
        function createKetone(id, l) { return wrapIcon(id, `${svgStart(60, 40)}<circle cx="15" cy="20" r="6" class="atom-c"/><circle cx="25" cy="20" r="6" class="atom-c"/><circle cx="35" cy="20" r="6" class="atom-c"/><circle cx="45" cy="20" r="6" class="atom-c"/><circle cx="25" cy="10" r="4" class="atom-o"/></svg>`, l); }
        function create3HB(id, l) { return wrapIcon(id, `${svgStart(60, 40)}<circle cx="15" cy="20" r="6" class="atom-c"/><circle cx="25" cy="20" r="6" class="atom-c"/><circle cx="35" cy="20" r="6" class="atom-c"/><circle cx="45" cy="20" r="6" class="atom-c"/><circle cx="25" cy="12" r="3" fill="#ffffff" stroke="#1e293b" stroke-width="2"/></svg>`, l); }
        function createAcetone(id, l) { return wrapIcon(id, `${svgStart(50, 40)}<circle cx="10" cy="25" r="6" class="atom-c"/><circle cx="25" cy="25" r="6" class="atom-c"/><circle cx="40" cy="25" r="6" class="atom-c"/><circle cx="25" cy="15" r="4" class="atom-o"/></svg>`, l); }
        function createMalonylCoA(id, l) { return wrapIcon(id, `${svgStart(60, 40)}<rect x="35" y="10" width="20" height="20" rx="4" fill="#94a3b8"/><text x="45" y="24" font-size="7" fill="white" text-anchor="middle">CoA</text><circle cx="10" cy="20" r="5" class="atom-c"/><circle cx="20" cy="20" r="5" class="atom-c"/><circle cx="30" cy="20" r="5" class="atom-c"/><circle cx="10" cy="10" r="4" class="atom-o"/></svg>`, l); }
        function createMevalonate(id, l) { return wrapIcon(id, `${svgStart(60, 60)}<path d="M10,50 L20,40 L20,20 L30,10" fill="none" stroke="#ec4899" stroke-width="3"/><circle cx="20" cy="20" r="6" fill="#ec4899"/><circle cx="40" cy="50" r="6" fill="#ec4899"/><path d="M20,40 L40,50" stroke="#ec4899" stroke-width="3"/></svg>`, l); }
        function createCholesterol(id, l) { return wrapIcon(id, `${svgStart(90, 60)}<rect x="15" y="25" width="15" height="15" fill="none" stroke="#eab308" stroke-width="2"/><rect x="30" y="25" width="15" height="15" fill="none" stroke="#eab308" stroke-width="2"/><rect x="45" y="25" width="15" height="15" fill="none" stroke="#eab308" stroke-width="2"/><rect x="60" y="25" width="15" height="15" fill="none" stroke="#eab308" stroke-width="2"/><text x="5" y="50" font-size="8" fill="#ec4899" font-weight="bold">HO</text><line x1="15" y1="40" x2="10" y2="45" stroke="#ec4899" stroke-width="2"/>`, l); }
        function createCholesterylEster(id, l) { return wrapIcon(id, `${svgStart(100, 70)}<rect x="15" y="25" width="15" height="15" fill="none" stroke="#eab308" stroke-width="2"/><rect x="30" y="25" width="15" height="15" fill="none" stroke="#eab308" stroke-width="2"/><rect x="45" y="25" width="15" height="15" fill="none" stroke="#eab308" stroke-width="2"/><rect x="60" y="25" width="15" height="15" fill="none" stroke="#eab308" stroke-width="2"/><line x1="15" y1="40" x2="10" y2="45" stroke="#f472b6" stroke-width="2"/><path d="M10,45 L5,50 L0,45" stroke="#ea580c" stroke-width="2" fill="none" transform="translate(5,0)"/>`, l); }

        function wrapIcon(id, svgContent, label) {
            return `
            <div id="${id}" class="molecule molecule-container flex flex-col items-center justify-center select-none transition-all cursor-grab active:cursor-grabbing">
                <div class="transform transition-transform scale-100 flex items-center justify-center w-full h-full p-3"> <!-- p-3 to shrink icon slightly -->
                    ${svgContent}
                </div>
                <span class="absolute -bottom-2 text-[10px] font-bold bg-white/90 px-2 py-0.5 rounded-full text-slate-600 shadow-sm whitespace-nowrap border border-slate-100 z-10 pointer-events-none">${label}</span>
            </div>`;
        }

        function createEnzymeBox(id, elemId) {
            const data = ELEMENTS[elemId];
            const isPathway = data.category === 'pathways';
            const extraClass = isPathway ? 'pathway' : '';
            return `
            <div id="${id}" class="molecule enzyme-box enzyme-container ${extraClass} select-none cursor-grab active:cursor-grabbing">
                <!-- Added pt-3 for top spacing like old design -->
                <div class="text-[10px] md:text-xs font-bold uppercase tracking-widest ${isPathway ? 'text-pink-700' : 'text-slate-500'} mb-1 pointer-events-none text-center px-1 leading-tight flex-none pt-4">${data.name}</div>
                <div class="flex flex-wrap justify-center gap-1 w-full px-1 pointer-events-none min-h-[20px] flex-1 items-center content-center" id="${id}-contents">
                    <span class="text-[9px] text-slate-400 italic">Drag items here</span>
                </div>
                <div class="mt-1 text-[9px] text-slate-400 text-center w-full px-1 leading-tight flex-none pb-2">
                    Needs: ${data.requires.map(r => ELEMENTS[r] ? ELEMENTS[r].name : r).join(', ')}
                </div>
            </div>`;
        }

        // --- SPAWN LOGIC (Click to Add) ---
        function spawnItemFromInventory(elemId) {
            const uid = 'obj-' + (nextId++);
            const wb = document.getElementById('workbench');
            const wbRect = wb.getBoundingClientRect();

            // Random scatter near center
            // Random scatter near center, relative to viewport size
            const centerX = wbRect.width / 2;
            const centerY = wbRect.height / 2;
            // 20% of viewport width/height spread
            const offsetX = (Math.random() - 0.5) * (wbRect.width * 0.2);
            const offsetY = (Math.random() - 0.5) * (wbRect.height * 0.2);

            // Determine size based on type for centering
            const isMolecule = ELEMENTS[elemId].category === 'molecules';
            // Approximate sizes from CSS: Molecule=5rem(80px), Enzyme=12rem(192px)
            // Hard to get exact before render, but we can estimate center offset
            const sizeEstimate = isMolecule ? 40 : 96; // Half-width approximation

            const newItem = {
                id: uid,
                elemId: elemId,
                type: isMolecule ? 'molecule' : 'enzyme',
                x: centerX + offsetX - sizeEstimate,
                y: centerY + offsetY - sizeEstimate,
                contents: []
            };

            workbenchItems.push(newItem);

            const div = document.createElement('div');
            // Use render logic to create element
            div.innerHTML = newItem.type === 'enzyme' ? createEnzymeBox(uid, elemId) : ELEMENTS[elemId].render(uid, ELEMENTS[elemId].name);
            const el = div.firstElementChild;

            el.style.position = 'absolute';
            el.style.left = newItem.x + 'px';
            el.style.top = newItem.y + 'px';

            // Pop In Animation
            el.animate([
                { transform: 'scale(0) translateY(20px)', opacity: 0 },
                { transform: 'scale(1) translateY(0)', opacity: 1 }
            ], { duration: 400, easing: 'cubic-bezier(0.34, 1.56, 0.64, 1)' });

            wb.appendChild(el);
            document.getElementById('tutorial-msg').style.display = 'none';
        }

        // --- DRAG AND DROP SYSTEM ---

        function handleGlobalStart(e) {
            const target = e.target.closest('.molecule');
            if (!target || !target.id.startsWith('obj-')) return;

            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;

            const touch = e.touches ? e.touches[0] : e;
            const clientX = touch.clientX;
            const clientY = touch.clientY;

            e.preventDefault();
            const item = workbenchItems.find(i => i.id === target.id);
            if (item) {
                startDragLogic(item, target, clientX, clientY, 'workbench');
            }
        }

        function startDragLogic(item, element, clientX, clientY, source) {
            dragState.active = true;
            dragState.item = item;
            dragState.source = source;
            dragState.element = element;

            // Optimization: Track last hovered items to minimize DOM updates
            dragState.lastHoveredId = null;
            dragState.lastTrashHovered = false;

            const rect = element.getBoundingClientRect();

            // Capture initial state for Transform logic
            dragState.startX = clientX;
            dragState.startY = clientY;
            dragState.initialLeft = rect.left;
            dragState.initialTop = rect.top;

            // Initialize current positions
            dragState.currentX = clientX;
            dragState.currentY = clientY;

            // CACHE drop targets so we don't query DOM on every move
            dragState.dropTargets = [];
            dragState.trashRect = document.getElementById('trash-bin').getBoundingClientRect();

            if (item.type === 'molecule') {
                workbenchItems.forEach(t => {
                    if (t.type === 'enzyme' && t.id !== item.id) {
                        const el = document.getElementById(t.id);
                        if (el) {
                            const r = el.getBoundingClientRect();
                            dragState.dropTargets.push({
                                id: t.id,
                                elemId: t.elemId,
                                left: r.left, right: r.right, top: r.top, bottom: r.bottom,
                                el: el
                            });
                        }
                    }
                });
            }

            if (element.parentElement.id !== 'drag-layer') {
                const layer = document.getElementById('drag-layer');
                // For transform drag, we ideally want to keep the element where it is visually
                // but move it to the drag layer. 
                // Set absolute position once, then use transforms.
                element.style.left = rect.left + 'px';
                element.style.top = rect.top + 'px';
                element.style.transform = 'translate3d(0,0,0) scale(1.1)';
                element.style.willChange = 'transform'; // Hint browser
                layer.appendChild(element);
            }

            element.classList.add('dragging');

            // Start Animation Loop
            dragState.rafId = requestAnimationFrame(updateDragVisual);
        }

        function handleGlobalMove(e) {
            if (!dragState.active) return;
            e.preventDefault();

            const touch = e.touches ? e.touches[0] : e;
            dragState.currentX = touch.clientX;
            dragState.currentY = touch.clientY;
            // logic is handled in updateDragVisual
        }

        function updateDragVisual() {
            if (!dragState.active) return;

            const dx = dragState.currentX - dragState.startX;
            const dy = dragState.currentY - dragState.startY;

            if (dragState.element) {
                // Apply Transform
                dragState.element.style.transform = `translate3d(${dx}px, ${dy}px, 0) scale(1.1)`;
            }

            // Hit Test Center
            // We need to calculate where the center IS now based on initial + delta
            const currentLeft = dragState.initialLeft + dx;
            const currentTop = dragState.initialTop + dy;
            const cx = currentLeft + (dragState.element.offsetWidth / 2);
            const cy = currentTop + (dragState.element.offsetHeight / 2);

            checkHover(cx, cy);
            checkTrashHover(cx, cy);

            dragState.rafId = requestAnimationFrame(updateDragVisual);
        }

        function checkHover(cx, cy) {
            if (dragState.item.type !== 'molecule') return;

            // Find current target
            let currentTarget = null;
            for (const target of dragState.dropTargets) {
                if (cx > target.left && cx < target.right && cy > target.top && cy < target.bottom) {
                    currentTarget = target;
                    break;
                }
            }

            // State Change Check
            const currentId = currentTarget ? currentTarget.id : null;
            if (currentId !== dragState.lastHoveredId) {
                // 1. Un-highlight previous
                if (dragState.lastHoveredId) {
                    const prevTarget = dragState.dropTargets.find(t => t.id === dragState.lastHoveredId);
                    if (prevTarget && prevTarget.el) {
                        prevTarget.el.style.transform = 'scale(1)';
                        // Reset to CSS default (Gray) unless it's a pathway (which uses class color)
                        prevTarget.el.style.borderColor = '';
                    }
                }

                // 2. Highlight new
                if (currentTarget) {
                    currentTarget.el.style.transform = 'scale(1.05)';
                    currentTarget.el.style.borderColor = '#f59e0b';
                }

                // 3. Update State
                dragState.lastHoveredId = currentId;
            }
        }

        function checkTrashHover(cx, cy) {
            const r = dragState.trashRect;
            const isHovered = (cx > r.left && cx < r.right && cy > r.top && cy < r.bottom);

            if (isHovered !== dragState.lastTrashHovered) {
                const trash = document.getElementById('trash-bin');
                if (isHovered) {
                    trash.classList.add('hovered');
                } else {
                    trash.classList.remove('hovered');
                }
                dragState.lastTrashHovered = isHovered;
            }
        }

        function handleGlobalEnd(e) {
            if (!dragState.active) return;

            // Stop loop
            if (dragState.rafId) cancelAnimationFrame(dragState.rafId);

            const el = dragState.element;
            const item = dragState.item;
            const wb = document.getElementById('workbench');
            const wbRect = wb.getBoundingClientRect();
            const trash = document.getElementById('trash-bin');

            // Calculate final position from transform
            // We need to commit the transform to actual top/left for placement
            const dx = dragState.currentX - dragState.startX;
            const dy = dragState.currentY - dragState.startY;

            // Center coords for drop logic
            const finalLeft = dragState.initialLeft + dx;
            const finalTop = dragState.initialTop + dy;

            const cx = finalLeft + (el.offsetWidth / 2);
            const cy = finalTop + (el.offsetHeight / 2);

            // Cleanup any visual highlights before processing logic
            if (dragState.lastHoveredId) {
                const prevTarget = dragState.dropTargets.find(t => t.id === dragState.lastHoveredId);
                if (prevTarget && prevTarget.el) {
                    prevTarget.el.style.transform = 'scale(1)';
                    prevTarget.el.style.borderColor = '';
                }
            }
            if (dragState.lastTrashHovered) {
                trash.classList.remove('hovered');
            }

            // Logic using exact same coordinate checks
            const trashRect = dragState.trashRect;
            if (cx > trashRect.left && cx < trashRect.right && cy > trashRect.top && cy < trashRect.bottom) {
                el.remove();
                const idx = workbenchItems.findIndex(i => i.id === item.id);
                if (idx > -1) workbenchItems.splice(idx, 1);

                trash.animate([
                    { transform: 'scale(1)' },
                    { transform: 'scale(1.2)' },
                    { transform: 'scale(1)' }
                ], { duration: 200 });

                resetDragState();
                return;
            }

            const insideWB = cx > wbRect.left && cx < wbRect.right && cy > wbRect.top && cy < wbRect.bottom;

            if (insideWB) {
                let consumed = false;
                // If we had a hovered target captured in state, we can use it (or re-check coords to be safe/atomic)
                // Integrating logic: relying on re-check for safety as per original "visual-logic split" request
                if (item.type === 'molecule') {
                    for (let target of dragState.dropTargets) {
                        if (cx > target.left && cx < target.right && cy > target.top && cy < target.bottom) {
                            const realTarget = workbenchItems.find(i => i.id === target.id);
                            if (realTarget) {
                                if (checkAccept(realTarget, item)) {
                                    acceptDrop(realTarget, item);
                                    consumed = true;
                                } else {
                                    rejectDrop(target.el);
                                }
                            }
                            break;
                        }
                    }
                }

                if (!consumed) {
                    item.x = finalLeft - wbRect.left;
                    item.y = finalTop - wbRect.top;

                    // Bounds Check
                    const rightBound = wbRect.width - el.offsetWidth;
                    const bottomBound = wbRect.height - el.offsetHeight;

                    if (item.x < 0) item.x = 0;
                    if (item.y < 0) item.y = 0;
                    if (item.x > rightBound) item.x = rightBound;
                    if (item.y > bottomBound) item.y = bottomBound;

                    el.classList.remove('dragging');
                    el.style.position = 'absolute';
                    // Commit final pos
                    el.style.left = item.x + 'px';
                    el.style.top = item.y + 'px';
                    // Reset transform and will-change
                    el.style.transform = '';
                    el.style.willChange = '';

                    el.style.zIndex = '';
                    wb.appendChild(el);
                } else {
                    el.remove();
                    const idx = workbenchItems.findIndex(i => i.id === item.id);
                    if (idx > -1) workbenchItems.splice(idx, 1);
                }
            } else {
                el.remove();
                const idx = workbenchItems.findIndex(i => i.id === item.id);
                if (idx > -1) workbenchItems.splice(idx, 1);
            }

            resetDragState();
        }

        function resetDragState() {
            dragState.active = false;
            dragState.element = null;
            dragState.item = null;
            dragState.dropTargets = [];
            dragState.trashRect = null;
            dragState.lastHoveredId = null;
            dragState.lastTrashHovered = false;
            dragState.rafId = null;
        }

        function rejectDrop(el) {
            el.classList.add('reject');
            setTimeout(() => el.classList.remove('reject'), 400);
        }

        // --- GAME LOGIC ---

        function checkAccept(target, item) {
            const eid = target.elemId;
            const iid = item.elemId;
            const enzymeData = ELEMENTS[eid];

            if (eid === '3hb_dehydrogenase') {
                return iid === 'ketone_body' || iid === '3_hydroxybutyrate';
            } else if (eid === 'thiolase') {
                return iid === 'acetyl_coa' || iid === 'acetoacetyl_coa';
            } else if (eid === 'acyltransferase') {
                const backbones = ['glycerol', 'cholesterol', 'monoacylglycerol', 'diacylglycerol'];
                const isBackbone = backbones.includes(iid);
                const isFA = iid === 'fatty_acid' || iid.endsWith('_acid');

                if (isBackbone) {
                    const hasBackbone = target.contents.some(k => backbones.includes(k));
                    return !hasBackbone;
                }
                if (isFA) {
                    const hasFA = target.contents.some(k => k === 'fatty_acid' || k.endsWith('_acid'));
                    return !hasFA;
                }
                return false;
            } else if (eid === 'lipase') {
                return iid === 'triglyceride' || iid === 'diacylglycerol' ||
                    iid === 'monoacylglycerol' || iid === 'cholesteryl_ester';
            } else if (eid === 'beta_oxidation') {
                const isSubstrate = iid.startsWith('acyl_coa') && iid !== 'acetyl_coa' && iid !== 'acyl_coa_3';
                if (!isSubstrate) return false;
                const hasSubstrate = target.contents.some(k => k.startsWith('acyl_coa') && k !== 'acetyl_coa' && k !== 'acyl_coa_3');
                return !hasSubstrate;

            } else if (eid === 'acyl_synthetase') {
                return true;
            } else if (eid === 'fas') {
                if (iid === 'malonyl_coa' || iid === 'nadph') return true;
                const isPrimerOrChain = iid === 'acetyl_coa' || iid === 'acyl_coa_3' || iid.endsWith('_acid');
                if (isPrimerOrChain) {
                    const hasPrimerOrChain = target.contents.some(k => k === 'acetyl_coa' || k === 'acyl_coa_3' || k.endsWith('_acid') || k.startsWith('acyl_coa'));
                    return !hasPrimerOrChain;
                }
                return false;

            } else if (eid === 'coa_transferase') {
                return iid === 'succinyl_coa' || iid === 'ketone_body';
            } else if (eid === 'pyruvate_dehydrogenase') {
                return iid === 'pyruvate';
            } else if (eid === 'citrate_synthase') {
                return iid === 'acetyl_coa' || iid === 'oaa';
            } else if (eid === 'citrate_lyase') {
                return iid === 'citrate';
            } else if (eid === 'pyruvate_carboxylase') {
                return iid === 'pyruvate' || iid === 'bicarbonate' || iid === 'atp';
            } else if (eid === 'malate_dehydrogenase') {
                return iid === 'malate' || iid === 'nad' || iid === 'oaa' || iid === 'nadh';
            } else if (eid === 'malic_enzyme') {
                return iid === 'malate';
            } else if (eid === 'glycolysis') {
                return iid === 'glucose';
            } else if (eid === 'etc') {
                return iid === 'nadh' || iid === 'fadh2';
            } else if (eid === 'spontaneous_pathway') {
                return iid === 'ketone_body';
            } else if (eid === 'acc') {
                return iid === 'acetyl_coa' || iid === 'bicarbonate' || iid === 'atp';
            } else if (eid === 'propionyl_coa_carboxylase') {
                return iid === 'acyl_coa_3' || iid === 'bicarbonate' || iid === 'atp';
            } else if (eid === 'methylmalonyl_coa_mutase') {
                return iid === 'methylmalonyl_coa';
            }
            return enzymeData.requires.includes(iid);
        }

        function acceptDrop(target, item) {
            target.contents.push(item.elemId);
            updateEnzymeContents(target);
            document.getElementById(target.id).style.transform = 'scale(1)';
            checkReaction(target);
        }

        function rejectDrop(el) {
            el.classList.add('reject');
            setTimeout(() => el.classList.remove('reject'), 400);
        }

        function updateEnzymeContents(item) {
            const container = document.getElementById(item.id + '-contents');
            if (!container) return;
            if (item.contents.length === 0) {
                container.innerHTML = `<span class="text-[9px] text-slate-400 italic">Drag items here</span>`;
            } else {
                container.innerHTML = item.contents.map(cid => {
                    const d = ELEMENTS[cid];
                    return `<div class="w-5 h-5 rounded-full border bg-white flex items-center justify-center text-[7px]" title="${d.name}">${d.name.substring(0, 2)}</div>`;
                }).join('');
            }
        }

        function checkReaction(item) {
            const eid = item.elemId;
            const data = ELEMENTS[eid];

            // Re-using the complex logic handlers from your uploaded file
            if (eid === 'acyl_synthetase') { handleSynthetase(item); return; }
            if (eid === 'beta_oxidation') { handleBetaOxidation(item); return; }
            if (eid === 'thiolase') { handleThiolase(item); return; }
            if (eid === 'fas') { handleFASLogic(item, data); return; }
            if (eid === '3hb_dehydrogenase') { handle3HBDehydrogenase(item); return; }
            if (eid === 'acyltransferase') { handleAcyltransferase(item); return; }
            if (eid === 'lipase') { handleLipase(item); return; }
            if (eid === 'coa_transferase') { handleCoATransferase(item); return; }
            if (eid === 'malate_dehydrogenase') { handleMalateDehydrogenase(item); return; }
            if (eid === 'etc') { handleETC(item); return; }
            if (eid === 'pyruvate_dehydrogenase') { handlePDH(item); return; }

            // Standard Logic
            const run = (products) => {
                const el = document.getElementById(item.id);
                el.classList.add('active-reaction');
                setTimeout(() => {
                    item.contents = [];
                    updateEnzymeContents(item);
                    products.forEach(p => spawnProduct(item, p));
                    el.classList.remove('active-reaction');
                }, 800);
            };

            const reqs = [...data.requires];
            const current = [...item.contents];
            let hasAll = true;
            for (let r of reqs) {
                const idx = current.indexOf(r);
                if (idx !== -1) {
                    current.splice(idx, 1);
                } else {
                    hasAll = false; break;
                }
            }

            if (hasAll && current.length === 0) {
                run(data.produces);
            }
        }

        // --- REACTION HANDLERS ---
        function spawnProduct(originItem, elemId) {
            const uid = 'obj-' + (nextId++);

            // Get Origin Element Size for relative placement
            const originEl = document.getElementById(originItem.id);
            const originRect = originEl ? originEl.getBoundingClientRect() : { width: 100, height: 100 };

            // Spawn just outside the enzyme box
            // Enzyme width is approx 12rem (192px) or 10rem (160px) on mobile
            // We want to spawn products slightly to the right/bottom

            const offsetX = (Math.random() * 40 - 20);
            const offsetY = (Math.random() * 20);

            // Dynamic offset based on enzyme size
            const spawnBaseX = originRect.width * 0.6;
            const spawnBaseY = originRect.height * 0.6;

            const newItem = {
                id: uid, elemId: elemId, type: 'molecule',
                x: originItem.x + spawnBaseX + offsetX,
                y: originItem.y + spawnBaseY + offsetY,
                contents: []
            };

            // Boundary checks
            const wb = document.getElementById('workbench');
            const rect = wb.getBoundingClientRect();
            // Molecule size approx 80px (5rem) or 56px (3.5rem)
            const molParams = rect.width < 768 ? 56 : 80;

            if (newItem.x > rect.width - molParams) newItem.x = rect.width - molParams;
            if (newItem.y > rect.height - molParams) newItem.y = rect.height - molParams;

            workbenchItems.push(newItem);

            const div = document.createElement('div');
            div.innerHTML = ELEMENTS[elemId].render(newItem.id, ELEMENTS[elemId].name);
            const el = div.firstElementChild;
            el.style.position = 'absolute';
            el.style.left = newItem.x + 'px';
            el.style.top = newItem.y + 'px';

            el.animate([
                { transform: 'scale(0) translateY(20px)', opacity: 0 },
                { transform: 'scale(1) translateY(0)', opacity: 1 }
            ], { duration: 400 });

            wb.appendChild(el);
        }

        function handlePDH(item) {
            if (item.contents.includes('pyruvate')) {
                const el = document.getElementById(item.id);
                el.classList.add('active-reaction');
                setTimeout(() => {
                    item.contents = []; updateEnzymeContents(item);
                    spawnProduct(item, 'acetyl_coa'); spawnProduct(item, 'nadh'); spawnProduct(item, 'co2');
                    el.classList.remove('active-reaction');
                }, 800);
            }
        }

        function handleETC(item) {
            if (item.contents.includes('nadh')) {
                const el = document.getElementById(item.id); el.classList.add('active-reaction');
                setTimeout(() => { item.contents = []; updateEnzymeContents(item); spawnProduct(item, 'atp'); spawnProduct(item, 'atp'); spawnProduct(item, 'atp'); el.classList.remove('active-reaction'); }, 800);
            } else if (item.contents.includes('fadh2')) {
                const el = document.getElementById(item.id); el.classList.add('active-reaction');
                setTimeout(() => { item.contents = []; updateEnzymeContents(item); spawnProduct(item, 'atp'); spawnProduct(item, 'atp'); el.classList.remove('active-reaction'); }, 800);
            }
        }

        function handleMalateDehydrogenase(item) {
            const c = item.contents;
            if (c.includes('malate') && c.includes('nad')) {
                const el = document.getElementById(item.id); el.classList.add('active-reaction');
                setTimeout(() => { item.contents = []; updateEnzymeContents(item); spawnProduct(item, 'oaa'); spawnProduct(item, 'nadh'); el.classList.remove('active-reaction'); }, 800);
            } else if (c.includes('oaa') && c.includes('nadh')) {
                const el = document.getElementById(item.id); el.classList.add('active-reaction');
                setTimeout(() => { item.contents = []; updateEnzymeContents(item); spawnProduct(item, 'malate'); spawnProduct(item, 'nad'); el.classList.remove('active-reaction'); }, 800);
            }
        }

        function handleCoATransferase(item) {
            if (item.contents.includes('succinyl_coa') && item.contents.includes('ketone_body')) {
                const el = document.getElementById(item.id); el.classList.add('active-reaction');
                setTimeout(() => { item.contents = []; updateEnzymeContents(item); spawnProduct(item, 'succinate'); spawnProduct(item, 'acetoacetyl_coa'); el.classList.remove('active-reaction'); }, 800);
            }
        }

        function handleLipase(item) {
            const c = item.contents;
            let out = null;
            if (c.includes('triglyceride')) out = ['glycerol', 'fatty_acid', 'fatty_acid', 'fatty_acid'];
            else if (c.includes('diacylglycerol')) out = ['glycerol', 'fatty_acid', 'fatty_acid'];
            else if (c.includes('monoacylglycerol')) out = ['glycerol', 'fatty_acid'];
            else if (c.includes('cholesteryl_ester')) out = ['cholesterol', 'fatty_acid'];

            if (out) {
                const el = document.getElementById(item.id); el.classList.add('active-reaction');
                setTimeout(() => { item.contents = []; updateEnzymeContents(item); out.forEach(p => spawnProduct(item, p)); el.classList.remove('active-reaction'); }, 800);
            }
        }

        // Updated Acyltransferase Logic
        function handleAcyltransferase(item) {
            const c = item.contents;
            const faList = c.filter(k => k.endsWith('_acid') || k === 'fatty_acid');
            const faCount = faList.length;

            if (faCount === 0) return; // No fatty acids to react with

            let product = null;
            let consumedFA = 0;

            // 1. Cholesterol Logic
            if (c.includes('cholesterol') && faCount >= 1) {
                product = 'cholesteryl_ester';
                consumedFA = 1;
                // remove 1 cholesterol
                const idx = item.contents.indexOf('cholesterol');
                if (idx > -1) item.contents.splice(idx, 1);
            }
            // 2. Glycerol Logic
            else if (c.includes('glycerol')) {
                const idx = item.contents.indexOf('glycerol');
                if (idx > -1) item.contents.splice(idx, 1);

                if (faCount >= 3) {
                    product = 'triglyceride';
                    consumedFA = 3;
                } else if (faCount === 2) {
                    product = 'diacylglycerol';
                    consumedFA = 2;
                } else {
                    product = 'monoacylglycerol';
                    consumedFA = 1;
                }
            }
            // 3. MAG Logic
            else if (c.includes('monoacylglycerol')) {
                const idx = item.contents.indexOf('monoacylglycerol');
                if (idx > -1) item.contents.splice(idx, 1);

                if (faCount >= 2) {
                    product = 'triglyceride';
                    consumedFA = 2;
                } else {
                    product = 'diacylglycerol';
                    consumedFA = 1;
                }
            }
            // 4. DAG Logic
            else if (c.includes('diacylglycerol')) {
                const idx = item.contents.indexOf('diacylglycerol');
                if (idx > -1) item.contents.splice(idx, 1);

                product = 'triglyceride';
                consumedFA = 1;
            }

            if (product) {
                // Remove consumed FAs
                for (let i = 0; i < consumedFA; i++) {
                    // Find an FA in contents and remove it
                    const faIndex = item.contents.findIndex(k => k.endsWith('_acid') || k === 'fatty_acid');
                    if (faIndex > -1) item.contents.splice(faIndex, 1);
                }

                // Identify extra FAs to release back (those remaining in contents)
                const extraFAs = item.contents.filter(k => k.endsWith('_acid') || k === 'fatty_acid');

                // Clear contents for reaction (logic has already removed consumed items, but we want clean slate visual reset)
                item.contents = [];
                updateEnzymeContents(item);

                const el = document.getElementById(item.id);
                el.classList.add('active-reaction');

                setTimeout(() => {
                    spawnProduct(item, product);
                    // Return any extra fatty acids
                    extraFAs.forEach(fa => spawnProduct(item, fa));
                    el.classList.remove('active-reaction');
                }, 800);
            }
        }

        function handleThiolase(item) {
            const ac = item.contents.filter(x => x === 'acetyl_coa').length;
            if (ac >= 2) {
                const el = document.getElementById(item.id); el.classList.add('active-reaction');
                setTimeout(() => {
                    item.contents.splice(item.contents.indexOf('acetyl_coa'), 1); item.contents.splice(item.contents.indexOf('acetyl_coa'), 1);
                    updateEnzymeContents(item); spawnProduct(item, 'acetoacetyl_coa'); el.classList.remove('active-reaction');
                }, 800);
                return;
            }
            if (item.contents.includes('acetoacetyl_coa')) {
                const el = document.getElementById(item.id); el.classList.add('active-reaction');
                setTimeout(() => { item.contents = []; updateEnzymeContents(item); spawnProduct(item, 'acetyl_coa'); spawnProduct(item, 'acetyl_coa'); el.classList.remove('active-reaction'); }, 800);
            }
        }

        function handleSynthetase(item) {
            const c = item.contents;
            if (!c.includes('atp')) return;
            const faMap = { 'stearic_acid': 'acyl_coa_18', 'palmitic_acid': 'acyl_coa_16', 'myristic_acid': 'acyl_coa_14', 'lauric_acid': 'acyl_coa_12', 'capric_acid': 'acyl_coa_10', 'caprylic_acid': 'acyl_coa_8', 'caproic_acid': 'acyl_coa_6', 'butyric_acid': 'acyl_coa_4', 'pentadecanoic_acid': 'acyl_coa_15', 'tridecanoic_acid': 'acyl_coa_13', 'undecanoic_acid': 'acyl_coa_11', 'nonanoic_acid': 'acyl_coa_9', 'heptanoic_acid': 'acyl_coa_7', 'valeric_acid': 'acyl_coa_5', 'propionic_acid': 'acyl_coa_3', 'fatty_acid': 'acyl_coa' };
            const fa = c.find(k => faMap[k]);
            if (fa) {
                const el = document.getElementById(item.id); el.classList.add('active-reaction');
                setTimeout(() => { item.contents = []; updateEnzymeContents(item); spawnProduct(item, faMap[fa]); spawnProduct(item, 'amp'); el.classList.remove('active-reaction'); }, 800);
            }
        }

        function handleBetaOxidation(item) {
            const c = item.contents;
            const acyls = Object.keys(ELEMENTS).filter(k => k.startsWith('acyl_coa'));
            const curr = c.find(k => acyls.includes(k));
            if (!curr || curr === 'acetyl_coa' || curr === 'acyl_coa_3') {
                if (curr) rejectDrop(document.getElementById(item.id));
                return;
            }
            const el = document.getElementById(item.id); el.classList.add('active-reaction');
            setTimeout(() => {
                item.contents = []; updateEnzymeContents(item);
                spawnProduct(item, 'acetyl_coa'); spawnProduct(item, 'nadh'); spawnProduct(item, 'fadh2');

                let next = null;
                if (curr === 'acyl_coa_18') next = 'acyl_coa_16'; else if (curr === 'acyl_coa_16') next = 'acyl_coa_14';
                else if (curr === 'acyl_coa_14') next = 'acyl_coa_12'; else if (curr === 'acyl_coa_12') next = 'acyl_coa_10';
                else if (curr === 'acyl_coa_10') next = 'acyl_coa_8'; else if (curr === 'acyl_coa_8') next = 'acyl_coa_6';
                else if (curr === 'acyl_coa_6') next = 'acyl_coa_4'; else if (curr === 'acyl_coa_4') next = 'acetyl_coa';
                else if (curr === 'acyl_coa_15') next = 'acyl_coa_13'; else if (curr === 'acyl_coa_13') next = 'acyl_coa_11';
                else if (curr === 'acyl_coa_11') next = 'acyl_coa_9'; else if (curr === 'acyl_coa_9') next = 'acyl_coa_7';
                else if (curr === 'acyl_coa_7') next = 'acyl_coa_5'; else if (curr === 'acyl_coa_5') next = 'acyl_coa_3';
                else if (curr === 'acyl_coa') next = 'acyl_coa';

                if (next) spawnProduct(item, next);
                el.classList.remove('active-reaction');
            }, 800);
        }

        function handle3HBDehydrogenase(item) {
            if (item.contents.includes('ketone_body')) {
                const el = document.getElementById(item.id); el.classList.add('active-reaction');
                setTimeout(() => { item.contents = []; updateEnzymeContents(item); spawnProduct(item, '3_hydroxybutyrate'); el.classList.remove('active-reaction'); }, 800);
            } else if (item.contents.includes('3_hydroxybutyrate')) {
                const el = document.getElementById(item.id); el.classList.add('active-reaction');
                setTimeout(() => { item.contents = []; updateEnzymeContents(item); spawnProduct(item, 'ketone_body'); el.classList.remove('active-reaction'); }, 800);
            }
        }

        function handleFASLogic(item, data) {
            const c = item.contents;
            const hasMalonyl = c.includes('malonyl_coa');
            const hasNADPH = c.includes('nadph');

            let starter = null;
            if (c.includes('acetyl_coa')) starter = 'acetyl_coa';
            if (!starter && c.includes('acyl_coa_3')) starter = 'acyl_coa_3';
            if (!starter) starter = c.find(k => k.endsWith('_acid'));

            const invalid = c.find(k => k.startsWith('acyl_coa_') && k !== 'acyl_coa_3');
            if (invalid || starter === 'stearic_acid') {
                rejectDrop(document.getElementById(item.id)); item.contents = []; updateEnzymeContents(item);
                c.forEach(x => spawnProduct(item, x)); return;
            }

            if (starter && hasMalonyl && hasNADPH) {
                const el = document.getElementById(item.id); el.classList.add('active-reaction');
                setTimeout(() => {
                    item.contents = []; updateEnzymeContents(item);
                    let prod = null;
                    if (starter === 'acetyl_coa') prod = 'butyric_acid';
                    else if (starter === 'butyric_acid') prod = 'caproic_acid'; else if (starter === 'caproic_acid') prod = 'caprylic_acid';
                    else if (starter === 'caprylic_acid') prod = 'capric_acid'; else if (starter === 'capric_acid') prod = 'lauric_acid';
                    else if (starter === 'lauric_acid') prod = 'myristic_acid'; else if (starter === 'myristic_acid') prod = 'palmitic_acid';
                    else if (starter === 'palmitic_acid') prod = 'stearic_acid';
                    else if (starter === 'acyl_coa_3') prod = 'valeric_acid'; else if (starter === 'propionic_acid') prod = 'valeric_acid';
                    else if (starter === 'valeric_acid') prod = 'heptanoic_acid'; else if (starter === 'heptanoic_acid') prod = 'nonanoic_acid';
                    else if (starter === 'nonanoic_acid') prod = 'undecanoic_acid'; else if (starter === 'undecanoic_acid') prod = 'tridecanoic_acid';
                    else if (starter === 'tridecanoic_acid') prod = 'pentadecanoic_acid';

                    if (prod) spawnProduct(item, prod);
                    spawnProduct(item, 'co2');
                    el.classList.remove('active-reaction');
                }, 800);
            }
        }

        init();
    </script>
</body>

</html>